// pages/seckill/seckill.js
const app = getApp()

Page({

  /**
   * é¡µé¢çš„åˆå§‹æ•°æ®
   */
  data: {
    apiUrl: app.globalData.apiUrl,
    list: [],
    seckillBtnCss: "url(https://*****/blackbutton.png)",
    seckillBtnText: "ä¸‹ä¸€åœºç‚¹å¼€å§‹"
  },
  setList:function(){
    var that = this;
    var list = [];
    var name = ["ğŸ‡","ğŸ’","ğŸ‘","äºº","å˜","èº«","å¼€","å¿ƒ","è¶…","å˜","èº«","æ²¡","ç†","ç”±","æ”¾","ä¸","ä¸‹","ä½ ","çš„","ç¬‘","ç´","æœ‰","æ—³","ä¸","å¤š","å°±","çˆ±","è¿©","æ—³","å¿ƒ","æƒ…","æ·±","æ‰","ä¼š","ä¹…","ä¼´","ä½ ","æ—¶","å…‰","ä¸","ä¼š","è¾œ","è´Ÿ","ä½ ","è™š","ä¼ª","ç»ˆ","ç©¶","ä¼š","è¢«","å‘","ç°","è§","è¡€","å°","ä¾¯","çš„","å¥³","äºº","é‚£","ä»…","å­˜","çš„","éª„","å‚²","æ—©","å·²","å¤±","å»","å¦‚","æœ","æˆ‘","è¯´","ä¸€","åˆ‡","éƒ½","æ˜¯","å‡","çš„","ğŸ","è£†","æœ‰","è´§","ä¸","ä¿¡","è¯•","è¯•","å£","æœ‰","æ–™","ä¸","ä¿¡","æ‘¸","æ‘¸","ğŸ‰","è°ƒ","æ§","é‚£","è°","æˆ‘","è€","ä½ ","æˆ‘","è€","ä½ ","é‚£","è°","å¦©","åªš","è€Œ","å¤±","è‹","åŠ²","å¯¹","äº","ä»–","æˆ‘","åª","æ˜¯","å¦","ä¸€","ç§","æ„Ÿ","æƒ…","æ‘©","ç¾¯","åº§","å¤ª","é˜³","å¤ª","è€€","çœ¼","æœˆ","äº®","å¤ª","å†°","ğŸŠ","å¿ƒ","çš„","æˆ‘","å“­","æ³£","çš„","ä½ ","J","ğŸ","C","K","k","i","s","s","H","E","L","ğŸ","N","å€¾","è¿°","è†","å¬","æˆ‘","ä»¬","å¼€","å¼€","å¿ƒ","å¿ƒ","æˆ‘","ä»¬","å¿«","å¿«","ä¹","ä¹","æš§","æ˜§","æ˜¯","æ¶","çš„","æœ¬","æ€§","ç–¯","ç–¯","ç™«","ç™«","ä¸","ä»£","è¡¨","èª","éš","éš","ä¾¿","ä¾¿","å€¾","å¬","ä½ ","æ‰€","æœ‰","å¿ƒ","å£°","çº¢","é¢œ","æ€’","è","å€¾","å¤©","ä¸‹","ä½ ","ä¸€","ç›´","æ´»","åœ¨","æˆ‘","çš„","è®°","å¿†","ä¸­","ç›´","è¢«","ğŸ","ä»¿","æœª","ğŸŒ","è¶…","è¶Š","æƒ¯","ä¸€","ä¸ª","äºº","ç‹¬","è‡ª","å","åœ¨","çª—","å‰","å˜´","è§’","æ€","èµ·","ä¸€","ä¸","è‹","ç¬‘","å˜´","è§’","å‹¾","èµ·","ä¸€","ä¸","è‹¦","ç¬‘","å› ","ä¸º","æœ‰","äº†","å› ","ä¸º","æ‰€","ä»¥","æ‰","æœ‰","æ‰€","ä»¥","å¾Œ","é›¨","æ²¡","æœ‰","è„š","æ­¥","å£°","å›","åˆ°","åŸ","ç‚¹","å´","å›","ä¸","åˆ°","åŸ","æ¥","é™ª","ä½ ","åˆ°","æ°¸","è¿œ","éš","ä½ ","ğŸ‹","å¤©","è¾¹","æœ‰","é’±","è¦","æ‡‚","å¾—","å‡","è£…","æ²¡","é’±","è¦","æ‡‚","å¾—","åŒ…","è£…","å§","ç˜¦","ä½†","å½ª","æ‚","ç©¿","è¿‡","æŒ‡","ç¼","é€","å°„","çš„","é˜³","å…‰","å®","æ„¿","å¤±","æ‹","äº¦","ä¸","æƒ³","å¤±","ç¤¼","å¾€","äº‹","å¦‚","çƒŸ","å²","æœˆ","å¦‚","æ­Œ","å¦‚","æ¢¦","å¦‚","å¹»","é›¨","éœ²","å¿ƒ","ğŸˆ","ä¸Š","æ ¡","é—¨","å«","ç½‘","ä¸Š","ğŸ’","é‚»","ä¸´","çª—","è§‚","ğŸŒµ","ç´ ","å­","èŠ±","å¼€","å°","æƒ…","èˆ","éŸµ","å½’","å»","å¦‚","é£","å°","å°","æ°´","é©¬","ä¸€","å“","ç™½","ğŸŒ·","æ£®","æ—","æ•£","å¸ƒ","å­¤","å³°","æ— ","ä¼´","æ¼‚","äº®","å†°","ğŸŒ¾","æ°´","æ¸…","å¤©","è“","é‚€","æœˆ","å¯¹","å½±","æ— ","é—¨","æœ‰","ç¼˜","å‡Œ","æ³¢","å¾®","æ­¥","é—²","äº‘","æ¸…","çƒŸ","é¦™","æ¤¿","ä¸›","æ—","çµ","æ…§","å¯","äºº","å’Œ","é£","æˆ","é›¨","æ·±","ç§‹","æ— ","ç—•","é˜³","å…‰","çš„","èˆŸ","æ˜¥","å¤©","çš„","å»","æ¸…","æœˆ","æ— ","æ¢¦","è¿·","é¸Ÿ","å½’","æ—","é‡‘","è‰²","æ«","å¶","èŠ±","è‡ª","èŠ¬","èŠ³","å…«","æ","ç«","ç‘°","åˆ«","æ ·","åˆ«","æ ·","æ«","å¶","è½","è½","è‹±","è‹±","å¿«","ä¹","åŒ—","å‡¤","ç”·","é£","è€","è½¦","æ–°","è·¯","é›¾","é‡Œ","çœ‹","å§","ç½‘","é—´","æ•£","å¸ƒ","æ¢…","èŠ³","ç«¹","æ¸…","è¢…","è¢…","äº­","äº­","ä»","é›¾","ä¸­","æ¥","æºª","æ–½","æŸ”","æƒ…","å°","ğŸ’®","æ¯’","è¯","æŠ•","é¼ ","å¿Œ","å™¨","é‡","æ¸¡","æ— ","äºº","ğŸŒº","ğŸŒ¼","å…«","ä»™","ä¹‹","äºº","ä¹‰","ğŸŒ»","å®¹","è¾","æµ·","èª“","å±±","ç›Ÿ","è¡Œ","ä¾ ","ä»—","ä¹‰","ğŸŒ¸","å°","åˆº","çŒ¬","å¾®","ç¬‘","å¬","é›¨","ä¸‡","å¹´","ç™½","ç‹","ç‰","é›ª","é£˜","é£˜","å§»","è„‚","èŠ±","å¼€","å¢¨","æ¢…","ç´«","äº‘","è¿ª","å¨","å¢¨","å±±","ä¹¡","äºº","æ¼“","æ±Ÿ","æ¸”","ç«","æ´›","æ°´","æ¸”","ç¿","é£","å¤©","èˆ","èˆ","ğŸŒ¹","ä¸–","æ™¨","æ™“","å°","æ²™","å°˜","ç€‘","æœ¬","æ¥","æ— ","ç‰©","å‘¼","å„¿","å’³","å‘€","é¡º","é£","æ—‹","å­","é€†","å‘","é”¤","å¤´","å¸ƒ","è¡£","å°","è´©","ä¸‰","ç¾Š","å¼€","èœ","è‰","åŸ","å¯»","æ¢¦","è½","å¶","çº¢","ç§‹","è¶","èˆ","èŠ³","é¦™","ç‹¬","ç«‹","å¯’","ç§‹","è¥¿","åŒ—","è™","ä¸–","çºª","ç²¾","çµ","é•¿","å•¸","å½“","æ­Œ","é•¿","ä¹","å…´","å¥‹","å’«","å°º","å¹¸","ç¦","è“","è“","çš„","å¤©","å¿—","å–„","å¿—","ç¾","èµ°","å‘","æ˜¥","å¤©"];
    var date = new Date();
    var hour = date.getHours() - 10;
    if(hour > 10){hour = 10}
    console.log(hour)
    var number = ((date.getDate() * 66 + ((date.getMonth() + 1) * 320) + date.getDay() * 129 + 1)% (50 * hour)) + hour * 750;
    for(var i = 1; i <= 6; i++){
      var listOnce = [];
      var imgId = (33 * i + date.getDate())%200 + 1; 
      var imgString = "";
      if(imgId < 100){
        imgString = (Array(2).join(0) + imgId).slice(-2);
      }else{
        imgString = (Array(3).join(0) + imgId).slice(-3);
      }
      var nameId = (date.getMonth() + 1 + date.getDate())*(date.getDay() + 1 + i) % 643;
      var nameId2 = (date.getMonth() + 1 + date.getDay() + 1)*(date.getDate() + i) % 643;
      var userName = name[nameId] + name[nameId + 1] + "***" + name[nameId2];
      number = number - ((i - 1) * (((date.getDay() + 1) * 50 + date.getDate() * 58) % 60 + 1));
      if(number < 1){
        number = 0;
        imgString = "Img",
        userName = "ç­‰å¾…å‚ä¸"
      }
      listOnce = {
        pic: imgString,
        name: userName,
        number: number
      }
      list.push(listOnce);
    }
    that.setData({
      list: list
    })
    console.log(list)
  },

  // mark: å®šæ—¶å™¨
  timeShow: function(time){
    var that = this;
    var logCountDown = setInterval(function () {
      var date = new Date();
      var hour = date.getHours();
      var minute = date.getMinutes();
      if(minute > 20){
        that.setData({
          seckillBtnCss: "url(https://*****/blackbutton.png)",
        })
        if(hour >= 21){
          that.setData({
            seckillBtnText: "æ˜æ—©6ç‚¹å¼€å§‹"
          })
        }else if(hour < 6){
          that.setData({
            seckillBtnText: "ä¸‹ä¸€åœº6ç‚¹å¼€å§‹"
          })
        }else{
          that.setData({
            seckillBtnText: "ä¸‹ä¸€åœº" + (hour + 1) + "ç‚¹å¼€å§‹"
          })
        }
      }else{
        if(hour > 21){
          that.setData({
            seckillBtnText: "æ˜æ—©6ç‚¹å¼€å§‹",
            seckillBtnCss: "url(https://*****/blackbutton.png)",
          })
        }else if(hour < 6){
          that.setData({
            seckillBtnText: "ä¸‹ä¸€åœº6ç‚¹å¼€å§‹",
            seckillBtnCss: "url(https://*****/blackbutton.png)",
          })
        }else{
          var seckill = wx.getStorageSync('seckill');
          if(seckill == date.getDate() + "-" + hour){
            //æœ¬è½®å·²ç»å‚ä¸
            that.setData({
              seckillBtnText: "ä¸‹ä¸€åœº" + (hour + 1) + "ç‚¹å¼€å§‹",
              seckillBtnCss: "url(https://*****/blackbutton.png)",
            })
          }else{
            that.setData({
              seckillBtnCss: "none",
              seckillBtnText: ""
            })
          }
        }
      }
    }, 100)
  },

  //ç§’æ€
  seckillDo:function(){
    var that = this;
    if(that.data.seckillBtnText == ""){
      that.setData({
        seckillBtnCss: "url(https://*****/blackbutton.png)",
        seckillBtnText: "ä¸‹ä¸€åœº ç‚¹å¼€å§‹"
      })
      var date = new Date();
      wx.setStorageSync('seckill', date.getDate() + "-" + date.getHours());
      //å‘é€è¯·æ±‚
      var url = "";
      if(wx.getStorageSync('numPercentage') > 1000){
        url = that.data.apiUrl + 'seckill/paper';
      }else{
        url = that.data.apiUrl + 'seckill/water';
      }
      wx.request({
        url: url,
        data: {
          token: wx.getStorageSync('token'),
        },
        header: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'
        },
        method: "POST",
        success(res){
          console.log(res)
          if(res.data.fail == -1 || res.data.fail == -2){
            wx.showToast({
              title: "ç¤¼å“éƒ½é€å®Œäº†ï¼Œä¸‹ä¸€æ—¶æ®µå†è¯•è¯•~",
              icon: 'none',
              duration: 2500
            })
          }else if(res.data.fail == -3){
            wx.showToast({
              title: "ç°åœ¨ä¸åœ¨æŠ¢è´­æ—¶é—´å“Ÿ~",
              icon: 'none',
              duration: 2500
            })
          }else if(res.data.addWater > 0){
            wx.showToast({
              title: "æ‰‹æ°”ä¸é”™ï¼æŠ¢åˆ°" + res.data.addWater + "çº¸æµ†~",
              icon: 'none',
              duration: 2500
            })
          }else if(res.data.expressKey != ""){
            wx.showToast({
              title: "æ­å–œè·å¾—å·çº¸ç›´å‘åˆ¸ï¼é‡è¿›å°ç¨‹åºå¯è§å…¥å£~",
              icon: 'none',
              duration: 4000
            })
          }else{
            wx.showToast({
              title: "æ´»åŠ¨å¤ªæŒ¤äº†ï¼Œä¸‹æ¬¡ä¸€å®šèƒ½æŠ¢åˆ°~",
              icon: 'none',
              duration: 2500
            })
          }
        }
      })
    }else{
      wx.showToast({
        title: "ç°åœ¨ä¸èƒ½é¢†å–å“¦~",
        icon: 'none',
        duration: 2500
      })
    }
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
   */
  onLoad: function (options) {
    this.setList();
    this.timeShow();
  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ
   */
  onReady: function () {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢æ˜¾ç¤º
   */
  onShow: function () {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢éšè—
   */
  onHide: function () {

  },

  /**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢å¸è½½
   */
  onUnload: function () {

  },

  /**
   * é¡µé¢ç›¸å…³äº‹ä»¶å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸‹æ‹‰åŠ¨ä½œ
   */
  onPullDownRefresh: function () {

  },

  /**
   * é¡µé¢ä¸Šæ‹‰è§¦åº•äº‹ä»¶çš„å¤„ç†å‡½æ•°
   */
  onReachBottom: function () {

  },

  /**
   * ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
   */
  onShareAppMessage: function () {
    var url = "pages/paper/paper?k=n" + wx.getStorageSync('userId');
    return {
      title: "ã€å®Œå…¨å…è´¹ã€‘å¿«æ¥å…»å·çº¸ï¼Œä¸èŠ±é’±ä¸€ä¸ªæœˆèƒ½å…‘å¥½å‡ æï¼Œä¸æ¥å°±äºäº†ï¼",
      path: url,
      imageUrl: 'https://www.*****/paper/img/papershare.png',
    }
  }
})